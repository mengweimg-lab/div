<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MediaPipe Hand Landmarks (DIV + Index)</title>
<style>
  html, body { margin:0; height:100%; overflow:hidden; background:#000; }
  #wrap { position: fixed; inset: 0; }
  video {
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit: cover; /* 【UX】画面の隅々まで映像を表示して、没入感を高めるよ */
    transform: scaleX(-1); /* 【UX】鏡のように左右反転させて、直感的に動かせるようにするよ */
  }
  #layer {
    position:absolute; inset:0;
    pointer-events:none; /* マウス操作が下の映像の邪魔をしないようにするよ */
  }
  #msg {
    position: fixed; top:12px; left:12px;
    padding:8px 12px; border-radius:6px;
    background: rgba(0,0,0,.5); color:#fff; font-size:14px;
    /* 【UX】ユーザーに今の状況（準備中、認識中など）を親切に伝えるよ */
  }
  /* 【ステップ1】もっとリアルなシャボン玉にするよ */
  .circle {
    position: absolute;
    border-radius: 50%;
    pointer-events: none; /* マウスやタッチの邪魔にならないようにするよ */
    /* ハイライト（光の反射）と、内側の影（inset）を使って透明感を出すよ */
    background: radial-gradient(120% 120% at 30% 30%, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0) 20%);
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5), inset 2px 0 15px rgba(255, 0, 255, 0.2), inset -2px 0 15px rgba(0, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  /* キラキラ（ラメ）のデザインを追加するよ */
  .glitter {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    /* 色はJavaScriptで決めるから、ここでは形だけ決めるよ */
    background: #fff;
  }
</style>
</head>
<body>

<div id="wrap">
  <video id="cam" autoplay playsinline></video>
  <div id="layer"></div>
</div>
<div id="msg">初期化中…</div>

<script type="module">
// MediaPipe（AIの道具箱）を読み込むよ
import { HandLandmarker, FilesetResolver } from
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

const video = document.getElementById("cam");
const layer = document.getElementById("layer");
const msg = document.getElementById("msg");

let handLandmarker;
let lastVideoTime = -1;

/* 【ステップ2】泡とキラキラを作り出す関数にパワーアップさせるよ */
function makeCircle(x, y) {
  // --- 1. 泡（バブル）を作る ---
  const size = Math.random() * 60 + 20; // 少し小さめにするよ

  const div = document.createElement("div");
  div.className = "circle";
  div.style.width = size + "px";
  div.style.height = size + "px";
  div.style.left = (x - size/2) + "px";
  div.style.top = (y - size/2) + "px";
  // 色はCSSで決めたから、ここでは設定しないよ

  document.body.appendChild(div);

  // 泡のアニメーション：ふわふわ浮かんで消える
  const anim = div.animate(
    [ 
      { opacity: 0, transform: "scale(0.5) translateY(0)" }, 
      { opacity: 1, transform: "scale(1) translateY(-20px)", offset: 0.2 },
      { opacity: 0, transform: "scale(1.1) translateY(-100px)" } 
    ],
    { duration: 2000, fill: "forwards" }
  );
  anim.onfinish = () => div.remove();

  // --- 2. 細かいラメ（キラキラ）を作る ---
  // 色のリスト（白、黄色寄り、青寄り、ピンク寄り）
  const colors = ["#ffffff", "#ffffdd", "#ddffff", "#ffddf0"];

  // 1回につき、5個くらいのキラキラを散らすよ
  for(let i=0; i<5; i++) {
    const gSize = Math.random() * 3 + 1; // 1px〜4pxのとても小さな粒
    const gDiv = document.createElement("div");
    gDiv.className = "glitter";
    gDiv.style.width = gSize + "px";
    gDiv.style.height = gSize + "px";
    
    // ランダムに色を選んでつけるよ
    const color = colors[Math.floor(Math.random() * colors.length)];
    gDiv.style.background = color;
    gDiv.style.boxShadow = `0 0 4px ${color}`; // その色の光をまとわせるよ
    
    // 指の周りにランダムに配置するよ
    const gX = x + (Math.random() - 0.5) * 60;
    const gY = y + (Math.random() - 0.5) * 60;
    gDiv.style.left = gX + "px";
    gDiv.style.top = gY + "px";

    document.body.appendChild(gDiv);

    // キラキラのアニメーション：ピカッと光ってすぐ消える
    const gAnim = gDiv.animate(
      [ { opacity: 1, transform: "scale(0)" }, { opacity: 1, transform: "scale(1)" }, { opacity: 0, transform: "scale(0)" } ],
      { duration: Math.random() * 600 + 400, fill: "forwards" }
    );
    gAnim.onfinish = () => gDiv.remove();
  }
}

// カメラを起動する関数だよ
async function startCamera(){
  // 【UX】インカメラ（user）を使って、鏡のように自分を映すよ
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }, audio: false
  });
  video.srcObject = stream;
  // 映像の準備ができるのを待つよ
  await new Promise(r => video.onloadedmetadata = r);
  // 再生スタート！
  await video.play().catch(()=>{});
}

// AI（MediaPipe）を準備する関数だよ
async function initMediaPipe(){
  // AIのプログラムを読み込むよ
  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
  );
  // 手を見つけるための設定をするよ
  handLandmarker = await HandLandmarker.createFromOptions(vision, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
    },
    runningMode: "VIDEO", // 動画モードで動かすよ
    numHands: 2 // 【ステップ1】手は2つまで探すように変更するよ
  });
}

// ずっと繰り返して、映像をチェックし続ける関数だよ
function loop(){
  const now = performance.now();

  // 映像が新しくなっていたら処理をするよ
  if (video.currentTime !== lastVideoTime) {
    // AIに手を探してもらうよ
    const result = handLandmarker.detectForVideo(video, now);
    lastVideoTime = video.currentTime;

    // 【ステップ2】見つかった「すべての手」に対して順番に処理をするよ
    if (result.landmarks && result.landmarks.length > 0) {
      // 【UX】認識できていることをメッセージで伝えるよ
      msg.textContent = "手を検出中";
      
      // 画面の大きさ（幅と高さ）を測るよ
      const rect = layer.getBoundingClientRect();

      // for...of という書き方で、見つかった手を1つずつ取り出して処理するよ
      for (const hand of result.landmarks) {
        /* 人差し指の先端（8番）から円を出すよ */
        const p8 = hand[8]; // 8番が人差し指の先だよ
        if (p8) {
          // 座標を計算するよ（反転に注意！）
          const x = (1 - p8.x) * rect.width;
          const y = p8.y * rect.height;
          // さっき作った関数を実行！ここで円が生まれるよ
          makeCircle(x, y);
        }
      }
    } else {
      // 手が見つからないときはメッセージを出して、点も隠すよ
      msg.textContent = "手が見つかりません";
    }
  }
  // 次の画面更新のタイミングで、また呼んでね
  requestAnimationFrame(loop);
}

// 最初に実行されるメインの処理だよ
(async function main(){
  try {
    // カメラとAIの準備を順番に行うよ
    await startCamera();
    await initMediaPipe();
    // 準備完了！
    msg.textContent = "手を映してください";
    // ループ処理を開始するよ
    requestAnimationFrame(loop);
  } catch (e) {
    console.error(e);
    // 【UX】エラーが起きたら、理由のヒントを表示するよ
    msg.textContent = "起動できません（HTTPS/権限を確認）";
  }
})();
</script>

</body>
</html>
